---
title: "ğŸ”‘ AWSã§æ§‹ç¯‰ã—ãŸRedashã‚’SSLåŒ–ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ”‘"
type: "tech"
topics: ["AWS", "Redash", "SSL", "Nginx"]
published: true
created_at: "2024-09-01T00:00:00.000Z"
published_at: "2024-09-01T00:00:00.000Z"
---

# AWSã§æ§‹ç¯‰ã—ãŸRedashã‚’SSLåŒ–ã™ã‚‹æ–¹æ³•

## ğŸ“Œ Redashã¨ã¯ï¼Ÿ

ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã—ã¦ã¯ã€BIãƒ„ãƒ¼ãƒ«ï¼ˆBusiness Intelligence Toolï¼‰ã®ã²ã¨ã¤ã«å«ã¾ã‚Œã¾ã™ã€‚[Redash](https://redash.io/)ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’ã€Œè¦‹ãˆã‚‹åŒ–ã€ã™ã‚‹ãŸã‚ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã§ã™ã€‚

é€šå¸¸ã€ç°¡æ˜“çš„ã«æ§‹ç¯‰ã™ã‚‹ã ã‘ã§ã¯SSLåŒ–ãŒã•ã‚Œã¦ãŠã‚‰ãšã€httpsã®ã‚¢ã‚¯ã‚»ã‚¹ãŒã§ããªã„çŠ¶æ…‹ã§ã™ã€‚

## ğŸ“Œ æ‰‹é †

### å‰ææ¡ä»¶

- AWSä¸Šã«Redashç’°å¢ƒã‚’æ§‹ç¯‰æ¸ˆã¿
- ã‚­ãƒ¼ãƒšã‚¢ã‚’æ‰€å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®æ¸ˆã¿

### ã‚³ãƒãƒ³ãƒ‰

> redash.example.com ã®ç®‡æ‰€ã‚’ä»»æ„ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å·®ã—æ›¿ãˆã¦ãã ã•ã„

1. SSHæ¥ç¶š

```bash
ssh -i "redash.pem" ubuntu@xxxxxxxxxx.ap-northeast-1.compute.amazonaws.com
```

2. Nginxãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨è¨¼æ˜æ›¸ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ

```bash
mkdir nginx
cd nginx
mkdir certs
mkdir certs-data
touch nginx.conf
```

3. `nginx.conf`ã‚’ç·¨é›†

```nginx
upstream redash {
    server redash:5000;
}

server {
    listen 80;
    listen [::]:80;
    server_name redash.example.com;

    location ^~ /ping {
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_pass http://redash;
    }

    location / {
        rewrite ^ https://$host$request_uri? permanent;
    }

    location ^~ /.well-known {
        allow all;
        root /data/letsencrypt/;
    }
}
```

4. Let's Encryptã‚’ä½¿ç”¨ã—ãŸSSLè¨¼æ˜æ›¸ã®å–å¾—ã¨è¨­å®š

```bash
# certbot-autoã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨å®Ÿè¡Œæ¨©é™ä»˜ä¸
wget https://dl.eff.org/certbot-auto
chmod a+x certbot-auto

# SSLè¨¼æ˜æ›¸ã®å–å¾—
sudo ./certbot-auto certonly --webroot -w /var/www/letsencrypt -d redash.example.com
```

5. HTTPSç”¨ã®Nginxè¨­å®šã‚’è¿½åŠ 

```nginx
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name redash.example.com;

    server_tokens off;

    ssl_certificate /etc/letsencrypt/live/redash.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/redash.example.com/privkey.pem;

    ssl_buffer_size 8k;
    ssl_dhparam /etc/ssl/certs/dhparam-2048.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

    ssl_ciphers ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5;

    ssl_ecdh_curve secp384r1;
    ssl_session_tickets off;

    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8;

    location / {
        try_files $uri @redash;
    }

    location @redash {
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_pass http://redash;
    }
}
```

6. Docker Composeãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°

```yaml
# nginx serviceã‚’è¿½åŠ 
nginx:
  image: nginx:alpine
  ports:
    - "80:80"
    - "443:443"
  volumes:
    - ./nginx/nginx.conf:/etc/nginx/nginx.conf
    - ./nginx/certs:/etc/letsencrypt
    - ./nginx/certs-data:/data/letsencrypt
  depends_on:
    - redash
```

7. ã‚µãƒ¼ãƒ“ã‚¹ã®å†èµ·å‹•

```bash
sudo docker-compose down
sudo docker-compose up -d
```

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **è¨¼æ˜æ›¸ã®æ›´æ–°ã‚¨ãƒ©ãƒ¼**
   - Let's Encryptã®è¨¼æ˜æ›¸ã¯90æ—¥ã§æœŸé™åˆ‡ã‚Œã«ãªã‚‹ãŸã‚ã€å®šæœŸçš„ãªæ›´æ–°ãŒå¿…è¦
   - cronã§è‡ªå‹•æ›´æ–°ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚’æ¨å¥¨

2. **Nginxã®è¨­å®šã‚¨ãƒ©ãƒ¼**
   - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯: `nginx -t`
   - ãƒ­ã‚°ã®ç¢ºèª: `docker logs nginx_container_name`

3. **ãƒãƒ¼ãƒˆç«¶åˆ**
   - æ—¢ã«ãƒãƒ¼ãƒˆ80/443ãŒä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
   - `netstat -tulpn | grep :80`

## ğŸ“ ã¾ã¨ã‚

ã“ã®æ‰‹é †ã«ã‚ˆã‚Šã€AWSä¸Šã®Redashã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’SSLåŒ–ã—ã€HTTPSçµŒç”±ã§ã®å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚Let's Encryptã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ç„¡æ–™ã§SSLè¨¼æ˜æ›¸ã‚’å–å¾—ãƒ»é‹ç”¨ã§ãã¾ã™ã€‚

å®šæœŸçš„ãªè¨¼æ˜æ›¸æ›´æ–°ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®è¦‹ç›´ã—ã‚’å¿˜ã‚Œãšã«è¡Œã„ã¾ã—ã‚‡ã†ã€‚